var ve=(d,S,v)=>{if(!S.has(d))throw TypeError("Cannot "+v)};var $=(d,S,v)=>(ve(d,S,"read from private field"),v?v.call(d):S.get(d)),te=(d,S,v)=>{if(S.has(d))throw TypeError("Cannot add the same private member more than once");S instanceof WeakSet?S.add(d):S.set(d,v)},se=(d,S,v,j)=>(ve(d,S,"write to private field"),j?j.call(d,v):S.set(d,v),v);(function(d,S){typeof exports=="object"&&typeof module!="undefined"?S(exports,require("@playwright/test"),require("events"),require("fs"),require("jmuxer"),require("stream"),require("os"),require("path"),require("child_process"),require("playwright-core"),require("util")):typeof define=="function"&&define.amd?define(["exports","@playwright/test","events","fs","jmuxer","stream","os","path","child_process","playwright-core","util"],S):(d=typeof globalThis!="undefined"?globalThis:d||self,S(d.playwright={},d.test$1,d.events,d.fs,d.JMuxer,d.stream,d.os,d.path,d.child_process,d.playwrightCore,d.util))})(this,function(d,S,v,j,ke,Pe,Te,Fe,Ie,$e,Y){var I,M;"use strict";function V(n){return n&&typeof n=="object"&&"default"in n?n:{default:n}}var A=V(j),Ce=V(ke),De=V(Te),C=V(Fe);S.expect.extend({toHaveElement:async(n,e,t={})=>{try{const s=await n.findElements(e,t);return{pass:typeof t.matches=="number"?s.length===t.matches:s.length>0,message:()=>`Element not found:
${JSON.stringify(e,null,2)}`}}catch(s){return{pass:!1,message:()=>s.message}}}});async function Me(n,{retries:e=3,timeout:t=1e3,predicate:s=()=>!0}){for(let i=1;i<=e;i++)try{return await n()}catch(r){if(i===e||!s(r,i))throw r;await new Promise(a=>setTimeout(a,t))}throw null}function Re(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function _e(n){return Object.entries(n).map(([e,t])=>typeof t!="undefined"?`${e}=${encodeURIComponent(t)}`:"").join("&")}function Oe(){let n,e,t,s;return{promise:new Promise((r,a)=>{t=o=>{n=o,r(o)},s=o=>{n=o,a(o)}}),resolve:t,reject:s,resolved:n,rejected:e}}function T(n){return Array.isArray(n)?n.map(T).filter(e=>e!=null):typeof n=="object"&&n!==null?Object.entries(n).reduce((e,[t,s])=>{const i=T(s);return i!=null&&(e[t]=i),e},{}):n}class z{constructor(){this.log=this.createLogFn("log"),this.warn=this.createLogFn("warn"),this.error=this.createLogFn("error"),this.debug=this.createLogFn("log")}createLogFn(e){const t=new Set,s="[Appetize]",i=Function.prototype.bind.call(console[e],console,s);return i.once=r=>{if(!t.has(r))return t.add(r),i.call(console,r)},i}}class R extends v.EventEmitter{constructor(){super(),this.on("error",()=>{})}}function ie(n,e){if("captureStackTrace"in Error)Error.captureStackTrace(n,e);else{const t=new Error;Object.defineProperty(n,"stack",{configurable:!0,get(){const{stack:s}=t;return Object.defineProperty(this,"stack",{value:s}),s}})}}async function w(n,e){n instanceof x&&ie(n,e)}class x extends Error{constructor(e){super(e),this.name="Error",this.isOperational=!0,ie(this,this.constructor)}}class N extends x{constructor(e,t){super(t!=null?t:e.message),this.errorId=e.errorId,this.playback=e.playback}}class Ne extends N{constructor(e){super(e,`No element found for selector
${JSON.stringify(e.playback.action.element,null,2)}`)}}class qe extends N{constructor(e){super(e,`Action requires 1 unique element but the selector returned ${e.matchedElements.length}. Provide a \`matchIndex\` to pick an element below or add additional attributes to your selector.

${Ue(e.matchedElements)}`)}}class Le extends N{constructor(e){let t=e.message;if(e.message.match("outside the screen bounds")){const{action:s}=e.playback;"localPosition"in s&&s.localPosition?t=`localPosition (${s.localPosition.x}, ${s.localPosition.y}) for the element evaluates to a coordinate outside of screen bounds.`:t="Element is outside of screen bounds."}super(e,t)}}class ne extends N{constructor(e){super(e,`An internal error has occurred for the action:
${JSON.stringify(e.playback.action,null,2)}`)}}class _ extends x{}class re extends x{constructor(e,t){super(t),this.playback=e}}class J extends x{constructor(e){super(`App Recorder must be enabled to use ${e}. Please set "record" to true in the config.`)}}function Ue(n){const t=n.slice(0,5),s=n.length>5;return`${t.map((r,a)=>`// ${a}
${JSON.stringify(r,null,2)}`).join(`

`)}${s?`

...and ${n.length-5} more`:""}`}class k{static isValidElementSelector(e){if(typeof e!="object"||Array.isArray(e))throw new Error("Element must be an object");const t=Object.keys(e),i=Ke(t,["text","accessibilityIdentifier","accessibilityLabel","resource-id","content-desc","class","baseClass"]);if(i.length>0){const r=i.map(a=>`'${a}'`).join(", ");throw new Error(`Element has invalid properties: ${r}. Did you mean to put these under 'attributes'?`)}return e}static isCoordinatesWithinBounds(e,t){return!(e.x<0||e.x>t.width||e.y<0||e.y>t.height)}static isPositionWithinBounds(e){const t=E.toPositionValue(e.x),s=E.toPositionValue(e.y);return!(t<0||t>1||s<0||s>1)}static isValidNumber(e){return!(typeof e!="number"||isNaN(e))}}class E{static toBoolean(e){return e===1}static toNumber(e){return typeof e=="number"?e:typeof e=="boolean"||e===void 0?e?1:0:e==="inf"?1/0:e==="-inf"?-1/0:parseFloat(e)}static toObjCNumber(e){return e===1/0?"inf":e===-1/0?"-inf":e}static toPositionValue(e){if(typeof e=="string"){if(e.endsWith("%"))return parseInt(e,10)/100;throw new Error(`Invalid position value: ${e}. Must be a number between 0 and 1, or a string ending with %`)}return e}}function Ke(n,e){return n.filter(t=>e.includes(t))}class oe{constructor({platform:e,screen:t}){this.platform=e,this.screen=t}pixelToDip(e){return e/(this.screen.devicePixelRatio||1)}dipToPixel(e){return e*(this.screen.devicePixelRatio||1)}toInternal(e){const{attributes:t,bounds:s,...i}=e,r=()=>{if(s){const{x:o,y:c,width:h,height:u}=s;return this.platform==="android"?{x:this.dipToPixel(o),y:this.dipToPixel(c),width:this.dipToPixel(h),height:this.dipToPixel(u)}:{x:E.toObjCNumber(o),y:E.toObjCNumber(c),width:E.toObjCNumber(h),height:E.toObjCNumber(u)}}},a=()=>{if(t)return Object.keys(t).reduce((o,c)=>{if(this.platform==="ios")switch(c){case"userInteractionEnabled":case"isHidden":return{...o,[c]:t[c]?"1":"0"}}else this.platform;return{...o,[c]:t[c]}},{})};return T({...i,bounds:r(),attributes:a(),accessibilityElements:void 0})}toPublic(e){const{attributes:t,bounds:s,accessibilityElements:i,...r}=e,a=h=>this.platform==="android"?{x:this.pixelToDip(h.x),y:this.pixelToDip(h.y),width:this.pixelToDip(h.width),height:this.pixelToDip(h.height)}:{x:E.toNumber(h.x),y:E.toNumber(h.y),width:E.toNumber(h.width),height:E.toNumber(h.height)},o=h=>Object.keys(h).reduce((u,p)=>{switch(p){case"userInteractionEnabled":case"isHidden":return{...u,[p]:h[p]==="1"};default:return{...u,[p]:h[p]}}},{}),c=h=>h.map(u=>{const{accessibilityFrame:p}=u;return{...o(u),accessibilityFrame:p?a(p):void 0}});return T({...r,bounds:s?a(s):void 0,attributes:t?o(t):void 0,accessibilityElements:i?c(i):void 0})}}class je{constructor({platform:e,screen:t}){this.platform=e,this.screen=t,this.elementMapper=new oe({platform:e,screen:t})}pixelToDip(e){return e/(this.screen.devicePixelRatio||1)}dipToPixel(e){return e*(this.screen.devicePixelRatio||1)}getCoordinates(e,t){const s=E.toPositionValue(e.x),i=E.toPositionValue(e.y);return{x:s*t.width,y:i*t.height}}getPosition(e,t){return{x:e.x/t.width,y:e.y/t.height}}toInternalKey(e){switch(e){case"HOME":return"home";case"VOLUME_UP":return"volumeUp";case"VOLUME_DOWN":return"volumeDown"}return e}toPublicKey(e){switch(e){case"home":return"HOME";case"volumeUp":return"VOLUME_UP";case"volumeDown":return"VOLUME_DOWN"}return e}toInternal(e){return T((()=>{e=T(e);let s,i,r;if("element"in e&&e.element&&(s=this.elementMapper.toInternal(e.element)),"position"in e&&e.position){const a=E.toPositionValue(e.position.x),o=E.toPositionValue(e.position.y);if(!k.isValidNumber(a)||!k.isValidNumber(o))throw new x(`Invalid position: (${e.position.x}, ${e.position.y}). Values must be a number or a percentage`);if(!k.isPositionWithinBounds(e.position))throw typeof e.position.x=="string"?new Error(`Invalid position: (${e.position.x}, ${e.position.y}) must be within (0%, 0%) and (100%, 100%)`):new Error(`Invalid position: (${e.position.x}, ${e.position.y}) must be within (0, 0) and (1, 1)`);this.platform==="android"?i=this.getCoordinates(e.position,{width:this.dipToPixel(this.screen.width)-1,height:this.dipToPixel(this.screen.height)-1}):i=this.getCoordinates(e.position,{width:this.screen.width-1,height:this.screen.height-1})}else if("coordinates"in e&&e.coordinates){if(!k.isValidNumber(e.coordinates.x)||!k.isValidNumber(e.coordinates.y))throw new x(`Invalid coordinates: (${e.coordinates.x}, ${e.coordinates.y}). Values must be a number`);if(!k.isCoordinatesWithinBounds(e.coordinates,{width:this.screen.width-1,height:this.screen.height-1}))throw new x(`Invalid coordinates: (${e.coordinates.x}, ${e.coordinates.y}) exceed screen bounds (${this.screen.width-1}, ${this.screen.height-1})`);this.platform==="android"?i={x:this.dipToPixel(e.coordinates.x),y:this.dipToPixel(e.coordinates.y)}:i=e.coordinates}if("localPosition"in e&&e.localPosition){const a=E.toPositionValue(e.localPosition.x),o=E.toPositionValue(e.localPosition.y);if(!k.isValidNumber(a)||!k.isValidNumber(o))throw new x(`Invalid localPosition: (${e.localPosition.x}, ${e.localPosition.y}). Values must be a number or a percentage`);r={x:a,y:o}}else s&&(r={x:.5,y:.5});if("duration"in e&&e.duration&&!k.isValidNumber(e.duration))throw new x(`Invalid duration: ${e.duration}. Value must be a number`);switch(e.type){case"tap":{const{position:a,...o}=e;return{...o,element:s,localPosition:r,coordinates:i}}case"swipe":{const{position:a,...o}=e;return{...o,element:s,localPosition:r,coordinates:i,moves:e.moves.map(c=>{if(this.platform==="android"){const{x:h,y:u}=this.getCoordinates(c,{width:this.dipToPixel(this.screen.width)-1,height:this.dipToPixel(this.screen.height)-1});return{...c,x:h,y:u}}else{const{x:h,y:u}=this.getCoordinates(c,{width:this.screen.width-1,height:this.screen.height-1});return{...c,x:h,y:u}}})}}case"keypress":{const a=this.toInternalKey(e.key),o=this.toInternalKey(e.character);return{...e,key:a,character:o,shiftKey:this.platform==="ios"?E.toNumber(e.shiftKey):e.shiftKey}}case"findElements":return{...e,element:s}}return e})())}toPublic(e){return T((()=>{let s,i,r,a="localPosition"in e?e.localPosition:void 0;switch("coordinates"in e&&e.coordinates&&(i={x:this.pixelToDip(e.coordinates.x),y:this.pixelToDip(e.coordinates.y)},r=this.getPosition(i,{width:this.screen.width-1,height:this.screen.height-1})),"element"in e&&e.element&&(s=this.elementMapper.toPublic(e.element),i&&s.bounds&&(a=this.getPosition({x:i.x-s.bounds.x,y:i.y-s.bounds.y},{width:s.bounds.width,height:s.bounds.height}))),e.type){case"tap":return{...e,coordinates:i,element:s,position:r,localPosition:a};case"swipe":return{...e,coordinates:i,element:s,position:r,localPosition:a,moves:e.moves.map(o=>{const{x:c,y:h}=this.getPosition({x:this.pixelToDip(o.x),y:this.pixelToDip(o.y)},{width:this.screen.width-1,height:this.screen.height-1});return{x:c,y:h,t:o.t}})};case"keypress":{const o=this.toPublicKey(e.key),c=this.toPublicKey(e.character);return{...e,key:o,character:c,shiftKey:typeof e.shiftKey=="number"?E.toBoolean(e.shiftKey):Boolean(e.shiftKey)}}case"findElements":return{...e,element:s}}return e})())}}class ae{constructor({platform:e,screen:t,app:s}){this.app=s,this.platform=e,this.screen=t,this.actionMapper=new je({platform:e,screen:t}),this.elementMapper=new oe({platform:e,screen:t})}toInternal(e,t){switch(e){case"playAction":{const s=t,r=t.__noMap__?t.action:this.actionMapper.toInternal(s.action);return{type:e,value:{...s,action:r}}}}return{type:e,value:t}}toPublic(e,t){var s,i,r,a,o,c;switch(e){case"debug":return{type:"log",value:t};case"interceptResponse":return{type:"network",value:{type:"response",...t}};case"interceptRequest":return{type:"network",value:{type:"request",...t}};case"interceptError":return{type:"network",value:{type:"error",...t}};case"userError":return{type:"error",value:t};case"userInteractionReceived":return{type:"interaction",value:t};case"countdownWarning":return{type:"inactivityWarning",value:t};case"h264Data":return{type:"video",value:{...t,codec:"h264"}};case"frameData":return{type:"video",value:{...t,codec:"jpeg"}};case"audioData":return{type:"audio",value:{...t,codec:"aac"}};case"concurrentQueue":return{type:"queue",value:{type:"concurrent",name:t.name,position:t.position}};case"queue":return{type:"queue",value:{type:"session",position:t.position}};case"orientationChanged":return{type:e,value:t};case"chromeDevToolsUrl":return{type:"networkInspectorUrl",value:t};case"recordedAction":return{type:"action",value:this.actionMapper.toPublic(t)};case"playbackFoundAndSent":{const h=t;return{type:"playbackFoundAndSent",value:{...h,playback:{...h.playback,action:(s=h.playback)!=null&&s.action?this.actionMapper.toPublic(h.playback.action):void 0},matchedElements:(i=h.matchedElements)==null?void 0:i.map(u=>{if(u)return this.elementMapper.toPublic(u)})}}}case"playbackError":{const h=t;return{type:"playbackError",value:{...h,playback:{...h.playback,action:(r=h.playback)!=null&&r.action?this.actionMapper.toPublic(h.playback.action):void 0},matchedElements:(a=h.matchedElements)==null?void 0:a.map(u=>{if(u)return this.elementMapper.toPublic(u)})}}}case"uiDump":{const h=(o=t.ui)!=null?o:t.result,u=t.springboard,p=g=>{var l;return{...this.elementMapper.toPublic(g),children:(l=g.children)==null?void 0:l.map(p)}},y=[];return h&&(this.platform==="ios"?y.push({type:"app",appId:(c=this.app)==null?void 0:c.bundle,children:h.map(p)}):y.push({type:"app",children:h.map(p)})),u&&y.push({type:"app",appId:"com.apple.springboard",children:u.map(p)}),{type:"uiDump",value:y}}case"deleteEvent":return null}return{type:e,value:t}}}class Ve{toInternal(e,t){return{type:e,value:t}}toPublic(e,t){switch(e){case"userError":return{type:"error",value:t};case"concurrentQueue":return{type:"queue",value:{type:"concurrent",name:t.name,position:t.position}};case"queue":return{type:"queue",value:{type:"session",position:t.position}};case"deviceInfo":case"sessionInfo":case"sessionRequested":return{type:e,value:t}}return{type:e,value:t}}}class ze extends R{constructor({socket:e}){super(),this.eventMapper=new Ve,this._socket=e,e.on("*",({type:t,value:s})=>{const i=this.mapEmit(t,s);i===null||(this.emit(i.type,i.value),this.emit("*",i))})}mapEmit(e,t){return this.eventMapper.toPublic(e,t)}mapSend(e,t){return this.eventMapper.toInternal(e,t)}send(e,t){const s=this.mapSend(e,t);return this._socket.send(s.type,s.value)}disconnect(){return this._socket.disconnect()}}class Je extends R{constructor({socket:e,logger:t=new z}){super(),this.logger=t,this.socket=new ze({socket:e}),this.socket.on("*",({type:s,value:i})=>{s!=="newSession"&&(this.emit(s,i),this.emit("*",{type:s,value:i}))}),this.socket.on("newSession",()=>{this.queue&&(this.emit("queueEnd"),this.queue=void 0)}),this.on("queue",s=>{this.queue=s})}on(e,t){return super.on(e,t)}async startSession(e){throw new Error("Not implemented")}async setConfig(e){throw new Error("Not implemented")}getConfig(){return this._config}async waitForSessionStart(e){return new Promise(async(t,s)=>{const i=()=>{s(new Error("Session disconnected before it was ready"))},r=o=>{s(new Error(`Session failed to start - ${typeof o.message=="object"?JSON.stringify(o.message):o.message}`))},a=o=>{var c;s(new Error(`Session failed to start - ${(c=o==null?void 0:o.message)!=null?c:"Unknown error"}`))};try{this.on("error",a),e.on("disconnect",i),e.on("error",r),await e.waitUntilReady()}catch(o){s(o)}finally{this.off("error",a),e.off("disconnect",i),e.off("error",r)}t(e)})}}async function X(n,e=5e3){const t=Date.now();let s=!1;for(;;)try{return await n(r=>{if(r)throw s=!0,r})}catch(i){if(await new Promise(r=>setTimeout(r,100)),s||e!==null&&Date.now()-t>e)throw i}}async function B(n){return new Promise(e=>setTimeout(e,n))}async function O(n,e,t){const s=typeof t=="function"?{}:t,i=typeof t=="function"?t:t==null?void 0:t.predicate,r=typeof(s==null?void 0:s.timeout)!="undefined"?s.timeout:1e4;return new Promise((a,o)=>{const c=h=>{(!i||i(h))&&(n.off(e,c),a(h))};n.on(e,c),r!==null&&setTimeout(()=>{n.off(e,c),o(new _(`Timeout ${r}ms exceeded while waiting for event "${e}"`))},r)})}function Be(n){return n?{...T(n),device:n.deviceType||n.device}:{}}class We extends Je{constructor({socket:e,window:t,logger:s=new z,config:i,autoInit:r=!0}){super({socket:e,logger:s}),this.ready=!1,this.isRequestingSession=!1,this._lastSetConfigCallId=null,this.window=t,i&&this.assignConfig(i),this.window.on("*",async({type:a,value:o})=>{if(this.ready)switch(a){case"app":this.app=o,this.emit(a,o);break;case"deviceInfo":this.device=o,this.emit(a,o);break;case"config":this.assignConfig(o);break}}),this.window.on("reinit",()=>{this.ready=!1,this.session=void 0,this.init({isReinit:!0})}),this.socket.on("*",async({type:a,value:o})=>{if(this.ready)switch(a){case"newSession":try{this.isRequestingSession=!1,this.session=this.createSession(this._config,{path:o.path,token:o.sessionToken}),await this.waitForSessionStart(this.session),this.emit("session",this.session)}catch(c){this.session=void 0,this.emit("sessionError",c)}}}),r!==!1&&this.init()}async init(e={isReinit:!1}){await this.window.waitUntilReady();const t=async()=>{if(e.isReinit){const r=this._config,a=await this.setConfig({});return this.setConfig({record:!0,...r,...a})}else return this.setConfig({record:!0,...this._config})},[s,i]=await Promise.all([this.window.postMessage({type:"getApp"},!0),this.window.postMessage({type:"getDeviceInfo"},!0),t()]);this.app=s,this.device=i,this.ready=!0}async waitUntilReady(){if(!this.ready)return X(async()=>{if(!this.ready)throw new Error("Timed out waiting for client to be ready")},3e4)}async startSession(e){const t=this.isRequestingSession,s=()=>this.isRequestingSession===!1;this.isRequestingSession=!0;try{try{await this.waitUntilReady()}catch(i){const r=i instanceof Error?i.message:i;throw new Error(`Failed to start session. ${r}`)}if(s()||(this.session?await this.session.end():t&&(await this.cancelSessionRequest(),this.isRequestingSession=!0)),s()||await this.setConfig(e!=null?e:{}),s())throw new Error("Session request was cancelled");{const[i]=await Promise.all([new Promise((r,a)=>{const o=h=>{this.off("session",o),this.off("sessionError",c),this.off("error",c),r(h)},c=h=>{this.off("session",o),this.off("sessionError",c),this.off("error",c),h instanceof Error?a(h):h&&typeof h.message=="string"?a(new Error(`Session failed to start - ${h.message}`)):a(h)};this.on("session",o),this.on("sessionError",c),this.on("error",c)}),this.window.postMessage({type:"requestSession"},!0)]);return i}}finally{this.isRequestingSession=!1}}async endSession(){this.session?await this.session.end():this.isRequestingSession&&await this.cancelSessionRequest()}async config(e){return this.logger.warn("client.config() is deprecated and will be removed in a future major release. Use client.setConfig() instead."),this.setConfig(e)}async setConfig({buildId:e,publicKey:t,...s}){this._lastSetConfigCallId=Math.random().toString(36);const i=this._lastSetConfigCallId;if(!e&&t&&(e=t),e){const a=await this.window.postMessage({type:"loadApp",value:e},!0);if(a&&"error"in a){if(a.error==="cancelled")return this._config;throw new Error(a.error)}if(i!==this._lastSetConfigCallId)return this._config}const r=await this.window.postMessage({type:"setConfig",value:this.validateConfig({...s,...e?{publicKey:e}:{}})},!0);return this.assignConfig(r)}assignConfig(e){return e.autoplay===!0&&this.logger.warn.once("autoplay=true may cause the session to start before the SDK is ready. You should start the session programmatically using client.startSession() instead."),this._config=Be(e),this._config}validateConfig(e){return e}async cancelSessionRequest(){this.isRequestingSession&&(this.isRequestingSession=!1,await this.window.postMessage("endSession"),this.emit("sessionEnded"))}createSession(e,t){throw new Error("Not implemented")}}class He extends z{constructor(){super(...arguments),this.logHistory=[],this.logLevel=process.env.CI==="true"?"warnings-errors":"verbose",this.log=this.createPlaywrightLogFn("log",()=>this.logLevel==="verbose"),this.warn=this.createPlaywrightLogFn("warn",()=>this.logLevel==="verbose"||this.logLevel==="warnings-errors"),this.error=this.createPlaywrightLogFn("error",()=>this.logLevel==="verbose"||this.logLevel==="warnings-errors"),this.debug=this.createPlaywrightLogFn("debug",()=>this.logLevel==="verbose"),this.clearLogHistory=()=>{this.logHistory=[]}}createPlaywrightLogFn(e,t){const s=new Set,i="[Appetize]",r=(...a)=>{this.logHistory.push({method:e,data:a}),t()&&console[e](i,...a)};return r.once=a=>{if(!s.has(a))return s.add(a),r.call(console,a)},r}}const m=new He;function Ye(n){const e=n.length;let t="";for(let s=0;s<e;s+=65535){let i=65535;s+65535>e&&(i=e-s),t+=String.fromCharCode.apply(null,n.subarray(s,s+i))}return t}function Xe(n,e){if(typeof window=="undefined"&&typeof Buffer!="undefined"){const t=Buffer.from(n).toString("base64");return`data:${e};base64,`+t}else{const t=Ye(n),s=btoa(t);return`data:${e};base64,`+s}}class Qe{constructor({duration:e,stepDuration:t}){this.moves=[],this.duration=e,this.stepDuration=t!=null?t:16,this.moves=[{x:0,y:0}]}to(e,t){if(typeof e!="string"||typeof t!="string")throw new x('x and y must be strings and in percentages (e.g. "50%")');if(!e.endsWith("%")||!t.endsWith("%"))throw new x('x and y must be in percentages (e.g. "50%")');return this.moves.push({x:parseFloat(e)/100,y:parseFloat(t)/100}),this}wait(e){var s;const t=this.moves[this.moves.length-1];return t&&(t.wait=e+((s=t.wait)!=null?s:0)),this}build(){var o;const e=this.stepDuration,t=(o=this.duration)!=null?o:Math.max(500,e*(this.moves.length-1)),s=Math.floor(t/e),i=Math.floor(s/(this.moves.length-1)),r=[];let a=0;if(i===0){const c=(this.moves.length-1)*e;throw new Error(`Duration is too short for ${this.moves.length-1} moves, please set duration to at least ${c}ms`)}for(let c=0;c<this.moves.length-1;c++){const h=this.moves[c],u=this.moves[c+1],p=c===this.moves.length-2;for(let y=0;y<=i;y++){if(!p&&y===i)continue;const g=y/i,l=h.x+g*(u.x-h.x),f=h.y+g*(u.y-h.y),b=((c*i+y)*e+a)/1e3;r.push({x:l,y:f,t:b}),y===0&&h.wait&&(r.push({x:l,y:f,t:b+h.wait/1e3}),a+=h.wait)}if(c===this.moves.length-2&&u.wait){const y=r[r.length-1];r.push({x:y.x,y:y.y,t:y.t+u.wait/1e3})}}return r}up(e="50%"){const t=parseFloat(e);return this.to("0%",`-${t}%`)}down(e="50%"){const t=parseFloat(e);return this.to("0%",`${t}%`)}left(e="50%"){const t=parseFloat(e);return this.to(`-${t}%`,"0%")}right(e="50%"){const t=parseFloat(e);return this.to(`${t}%`,"0%")}}class Ge extends R{constructor({socket:e,platform:t,screen:s,app:i}){super(),this._socket=e,this.platform=t,this.screen=s,this.app=i,e.on("*",({type:r,value:a})=>{const o=this.mapEmit(r,a);o===null||(this.handleEvent(o.type,o.value),this.emit(o.type,o.value),this.emit("*",o))})}send(e,t){const s=this.mapSend(e,t);return this._socket.send(s.type,s.value)}disconnect(){return this._socket.disconnect()}handleEvent(e,t){switch(e){case"app":this.app=t;break;case"deviceInfo":{const s=t;s!=null&&s.screen&&(this.screen=s.screen);break}case"config":{const s=t;s.platform&&(this.platform=s.platform);break}}}mapEmit(e,t){return new ae({platform:this.platform,screen:this.screen,app:this.app}).toPublic(e,t)}mapSend(e,t){return new ae({platform:this.platform,screen:this.screen,app:this.app}).toInternal(e,t)}}class Ze extends R{constructor({socket:t,config:s,path:i,token:r,app:a,device:o,logger:c=new z}){super();te(this,I,void 0);te(this,M,void 0);this.isEndingManually=!1,this.countdownWarning=!1,this.ready=!1,this._waitForAnimationsPromises=new Set,this.config=s,this.socket=new Ge({socket:t,app:a,screen:o.screen,platform:s.platform}),this.device=o,this.app=a,this.path=i,this.token=r,this.logger=c;const h=({type:u,value:p})=>{switch(u){case"ready":this.ready=!0;break;case"adbOverTcp":{se(this,I,{...p,command:et(p)});break}case"networkInspectorUrl":se(this,M,p);break;case"countdownWarning":this.countdownWarning=!0;break;case"timeoutReset":this.countdownWarning=!1;break;case"deviceInfo":this.device=p;break;case"disconnect":this.emit("end"),this.emit("*",{type:"end"});break}this.emit(u,p),this.emit("*",{type:u,value:p})};this.socket.on("*",h),this.on("disconnect",()=>{this.socket.off("*",h),this.isEndingManually||(this.countdownWarning?this.logger.warn("Appetize session has ended due to inactivity"):this.logger.warn("Session disconnected"))})}on(t,s){return t==="network"&&this.config.proxy!=="intercept"&&this.logger.warn('Session must be configured with `proxy: "intercept"` to listen to network events.'),t==="log"&&this.config.debug!==!0&&this.logger.warn("Session must be configured with `debug: true` to listen to log events."),t==="action"&&this.config.record!==!0&&this.logger.warn("Session must configured with `record: true` to listen to action events."),super.on(t,s)}async waitUntilReady(){let t=!0;const s=async r=>new Promise(a=>{const o=setInterval(()=>{r()&&a(void 0)},10);setTimeout(()=>{clearInterval(o),a(void 0)},3e3)}),i=()=>{t=!1};this.socket.once("disconnect",i);try{await X(r=>{if(!this.ready){if(t)throw new _("Timed out after 180s waiting for session to be ready");r(new Error("Session disconnected"))}},18e4)}finally{this.socket.off("disconnect",i)}await Promise.all([this.config.proxy==="intercept"?s(()=>Boolean($(this,M))):Promise.resolve(),this.config.enableAdb?s(()=>Boolean($(this,I))):Promise.resolve()])}async waitForEvent(t,s){try{return await O(this,t,s)}catch(i){throw w(i,this.waitForEvent),i}}async end(){this.isEndingManually=!0,await this.socket.disconnect()}get networkInspectorUrl(){return this.config.proxy!=="intercept"&&this.logger.warn('Session must be configured with `proxy: "intercept"` to use the network inspector'),$(this,M)}get adbConnection(){if(this.config.platform&&this.config.platform!=="android"&&this.logger.warn("Session must be connected to an Android device to use adb"),this.config.enableAdb||this.logger.warn("Session must be configured with `enableAdb: true` to use adb"),$(this,I))return $(this,I)}async rotate(t){try{const[s]=await Promise.all([this.waitForEvent("orientationChanged"),this.socket.send("userInteraction",{type:"keypress",key:t==="left"?"rotateLeft":"rotateRight",timeStamp:Date.now()})]);return s}catch(s){throw w(s,this.rotate),s}}async screenshot(t="buffer"){var s;try{this.socket.send("getScreenshot",{});const i=await O(this.socket,"screenshot",{timeout:6e4});if(!i.success)throw new x((s=i.error)!=null?s:"Screenshot failed");return{data:t==="buffer"?(o=>typeof window=="undefined"?Buffer.from(o):o)(i.data):Xe(new Uint8Array(i.data),i.mimeType),mimeType:i.mimeType}}catch(i){throw w(i,this.screenshot),i}}async heartbeat(){try{return await this.socket.send("heartbeat")}catch(t){throw w(t,this.heartbeat),t}}async type(t){try{await B(1e3);const s=await this.playAction({type:"typeText",text:t});return await B(500),s}catch(s){throw w(s,this.type),s}}async keypress(t,s){try{if(t==="ANDROID_KEYCODE_MENU")return await this.socket.send("androidKeycodeMenu");if((s==null?void 0:s.shift)||t==="HOME"){switch(t){case"ArrowUp":t="arrowUp";break;case"ArrowDown":t="arrowDown";break;case"ArrowLeft":t="arrowLeft";break;case"ArrowRight":t="arrowRight";break;case"Enter":t="\r";break;case"Tab":t="	";break;case"Backspace":t="\b";break}return this.playAction({type:"keypress",key:t,shiftKey:!!(s!=null&&s.shift)})}else return this.playAction({type:"keypress",character:t})}catch(i){throw w(i,this.keypress),i}}async setLanguage(t){try{return this.config.language=t,await this.socket.send("setLanguage",{language:t,timeStamp:Date.now()})}catch(s){throw w(s,this.setLanguage),s}}async setLocation(t,s){try{if(typeof t!="number"||typeof s!="number")throw new x("setLocation requires latitude and longitude to be numbers");const i=[t,s];return this.config.location=i,await this.socket.send("setLocation",{location:i,timeStamp:Date.now()})}catch(i){throw w(i,this.setLocation),i}}async openUrl(t){try{return await this.socket.send("openUrl",{url:t,timeStamp:Date.now()})}catch(s){throw w(s,this.openUrl),s}}async launchApp(t){try{return await this.socket.send("launchApp",{appId:t,timeStamp:Date.now()})}catch(s){throw w(s,this.launchApp),s}}async shake(){try{return await this.socket.send("shakeDevice")}catch(t){throw w(t,this.swipe),t}}async toggleSoftKeyboard(){try{if(this.config.platform!=="ios")throw new Error("toggleSoftKeyboard is only available on iOS devices");return await this.socket.send("toggleSoftKeyboard")}catch(t){throw w(t,this.toggleSoftKeyboard),t}}async biometry({match:t}){try{return await this.socket.send(t?"biometryMatch":"biometryNonMatch")}catch(s){throw w(s,this.biometry),s}}async addMedia(t){if(t.size>50*1024*1024)throw new Error("Your proposed upload exceeds the maximum allowed size of 50MB");try{const s=`${this.path}/session/${this.token}/addMedia`,i=/[^\u0000-\u00ff]/g,r=t.name.replace(i,"-"),a=await fetch(s,{method:"POST",body:t,headers:{"X-Appetize-File-Name":r,"Content-Type":t.type}});if(!a.ok){const o=await a.text();throw new Error(`Failed to upload media file. Received ${a.status} - ${o}`)}return a}catch(s){throw w(s,this.addMedia),s}}async biometryEnrollment(t){try{if(this.config.platform!=="ios")throw new Error("biometryEnrollment is only available on iOS devices");return await this.socket.send("biometryEnrollment",{isEnrolled:t})}catch(s){throw w(s,this.biometryEnrollment),s}}async allowInteractions(t){try{return await this.socket.send(t?"enableInteractions":"disableInteractions")}catch(s){throw w(s,this.allowInteractions),s}}async restartApp(){try{this.isStandalone?this.logger.warn("restartApp has no effect on a Standalone"):(this.socket.send("restartApp"),await this.waitForEvent("appLaunch",{timeout:6e4}))}catch(t){throw w(t,this.restartApp),t}}async reinstallApp(){try{this.isStandalone?this.logger.warn("reinstallApp has no effect on a Standalone"):(this.socket.send("reinstallApp"),await this.waitForEvent("appLaunch",{timeout:6e4}))}catch(t){throw w(t,this.reinstallApp),t}}async adbShellCommand(t){if(this.config.platform!=="android")throw new Error("adbShellCommand is only available on Android devices");try{return await this.socket.send("adbShellCommand",{command:t,timeStamp:Date.now()})}catch(s){throw w(s,this.adbShellCommand),s}}async playAction(t,s={}){const{timeout:i=1e4}=s,r=1e4,a=i+3e4;try{if(!this.config.record)throw new J("playAction()");if(isNaN(i))throw new x(`Invalid timeout value: ${s.timeout}`);if(i<0)throw new x(`Timeout value cannot be negative: ${s.timeout}`);"element"in t&&t.element&&k.isValidElementSelector(t.element);const o={id:Re(),action:t,options:{...s,timeout:Math.round(Math.min(i,r)/1e3)}};try{return await new Promise((h,u)=>{const p=setTimeout(()=>{y(),u(new re({id:o.id,action:t,timeout:o.options.timeout},"Timed out waiting for response from device"))},a),y=()=>{this.off("playbackFoundAndSent",g),this.off("playbackError",l),clearTimeout(p)},g=async f=>{var b;((b=f.playback)==null?void 0:b.id)===o.id&&(y(),h(f))},l=async f=>{var b;if(((b=f.playback)==null?void 0:b.id)===o.id)switch(y(),f.errorId){case"internalError":u(new ne(f));break;case"notFound":{u(new Ne(f));break}case"ambiguousMatch":u(new qe(f));break;case"invalidArgument":{u(new Le(f));break}default:u(new N(f));break}};this.on("playbackFoundAndSent",g),this.on("playbackError",l),this.socket.send("playAction",o)})}catch(c){const h=Math.max(0,i-r);if(h>0&&!(c instanceof re)&&!(c instanceof ne))return await this.playAction(t,{...s,timeout:h});throw c}}catch(o){throw w(o,this.playAction),o}}async playActions(t,s={}){try{if(!this.config.record)throw new J("playActions()");const i=[];for(const r of t){const a=await this.playAction(r,s);i.push(a);const o=t[t.indexOf(r)+1];o&&o.type==="keypress"&&r.type==="keypress"||await this.waitForAnimations({timeout:2e3}).catch(()=>{})}return i}catch(i){throw w(i,this.playActions),i}}async getUI({timeout:t=3e4}={}){try{return this.socket.send("dumpUi"),await O(this,"uiDump",{timeout:t})}catch(s){throw w(s,this.getUI),s}}async findElement(t,s){var i;try{return(i=(await this.playAction({type:"findElements",element:t,appId:s==null?void 0:s.appId},s)).matchedElements)==null?void 0:i[0]}catch(r){throw w(r,this.findElement),r}}async findElements(t,s){try{return(await this.playAction({type:"findElements",element:t,appId:s==null?void 0:s.appId},s)).matchedElements}catch(i){throw w(i,this.findElements),i}}async tap(t,s){var i;try{if(!this.config.record)throw new J("tap()");return await this.playAction({type:"tap",...t,duration:((i=t.duration)!=null?i:0)/1e3},s)}catch(r){throw w(r,this.tap),r}}async swipe({duration:t,gesture:s,...i},r){try{if(!this.config.record)throw new J("swipe()");let a;const o=new Qe({duration:t,stepDuration:i.stepDuration});if(typeof s=="function")s(o);else switch(s){case"up":o.up();break;case"down":o.down();break;case"left":o.left();break;case"right":o.right();break}if("element"in i)a={type:"swipe",element:i.element,localPosition:i.localPosition,moves:o.build()};else if("position"in i)a={type:"swipe",position:i.position,moves:o.build()};else throw new Error("Either element or position must be specified");return this.playAction(a,r)}catch(a){throw w(a,this.swipe),a}}async waitForAnimations(t={}){try{const{imageThreshold:s=.001,timeout:i=1e4}=t;let r=1e3,a=1;t.imageThresholdDuration&&(r=t.imageThresholdDuration);const{promise:o,resolve:c,reject:h}=Oe(),u=setTimeout(()=>{let g=`Timed out after ${i}ms waiting for animation to end.`;s<a&&(g+=` Waited for imageThreshold of ${s} but lowest was ${Math.round(a*1e4)/1e4}`),h(new _(g))},i);let p;const y=({percentage:g,timestamp:l})=>{g<a&&(a=g),g<=s?(p||(p=l),p&&l-p>=r&&c()):p=void 0};return this.socket.send("enablePixelChangeDetection"),this.socket.on("pixelsChanged",y),this._waitForAnimationsPromises.add(o),await o.finally(()=>{clearTimeout(u),this.socket.off("pixelsChanged",y),this._waitForAnimationsPromises.delete(o),this._waitForAnimationsPromises.size===0&&this.socket.send("disablePixelChangeDetection")})}catch(s){throw w(s,this.waitForAnimations),s}}async getAdbInfo(){return this.logger.warn("getAdbInfo() is deprecated. Please use the `adbConnection` property instead."),Promise.resolve($(this,I))}async getNetworkInspectorUrl(){return this.logger.warn("getNetworkInspectorUrl() is deprecated. Please use the `networkInspectorUrl` property instead."),Promise.resolve($(this,M))}async getDeviceInfo(){return this.logger.warn("getDeviceInfo() is deprecated. Please use the `device` property instead."),Promise.resolve(this.device)}get isStandalone(){var t;return(t=this.app)!=null&&t.buildId?this.app.buildId.startsWith("standalone_"):!1}}I=new WeakMap,M=new WeakMap;function et(n){const e="ssh -fN -o StrictHostKeyChecking=no -oHostKeyAlgorithms=+ssh-rsa -p SERVER_PORT USERNAME@HOSTNAME -L6000:FORWARD_DESTINATION:FORWARD_PORT && adb connect localhost:6000";if(!n||!n.forwards[0])return;let t=e;return t=t.replace(/SERVER_PORT/,n.port.toString()),t=t.replace(/USERNAME/,n.user),t=t.replace(/HOSTNAME/,n.hostname),t=t.replace(/FORWARD_DESTINATION/,n.forwards[0].destination),t=t.replace(/FORWARD_PORT/,n.forwards[0].port.toString()),t}async function tt(n){await n.pause()}function W(n){if(n.character)return n.character;const e=n.key;return H(e)?e:n.shiftKey?e.toUpperCase():e.toLowerCase()}function H(n){return/^[\b\t\r]/.test(n)}class st{constructor({testInfo:e,session:t}){this.currentRecord=0,this.session=t,this.testInfo=e}async record(){const e=this.testInfo.file,t=await A.default.promises.readFile(e,"utf8"),i=t.split(`
`).map((r,a)=>({line:r,num:a+1})).slice(this.testInfo.line).filter(({line:r})=>r.includes("session.record()"))[this.currentRecord].num;if(i!==void 0){console.log(`\u{1F534} Recording at line ${i}`);const r=[],a=c=>{it(r,c),console.log(ce(c))};this.session.on("action",a),await tt(this.session.page),await B(2e3),this.session.off("action",a);const o=t.split(`
`).map((c,h)=>{var u,p;if(h===i-1){const y=(p=(u=c.match(/^\s*/))==null?void 0:u[0])!=null?p:0;return`${r.map(l=>ce(l)).reduce((l,f,b)=>`${l}
// ${b+1}. ${f}`,"// Recorded using session.record()")}
await session.playActions(${JSON.stringify(r,null,"	")})`.split(`
`).map(l=>y+l).join(`
`)}return c});await A.default.promises.writeFile(e,o.join(`
`)),console.log("\u{1F7E2} Finished"),this.currentRecord+=1}}}function it(n,e){const t=n[n.length-1];if(t)switch(e.type){case"keypress":{(t==null?void 0:t.type)==="keypress"&&!H(e.key)&&!H(t.key)?(n.pop(),n.push({type:"typeText",text:W(t)+W(e)})):(t==null?void 0:t.type)==="typeText"&&!H(e.key)?(n.pop(),n.push({type:"typeText",text:t.text+W(e)})):n.push(e);break}default:n.push(e)}else n.push(e)}function ce(n){var t,s,i,r,a,o;let e="";switch(n.type){case"swipe":case"tap":{const c=n.element;return typeof c=="string"?e=` on element "${c}"`:(t=c==null?void 0:c.attributes)!=null&&t.accessibilityIdentifier?e=`element with accessibilityIdentifier "${(s=c.attributes)==null?void 0:s.accessibilityIdentifier}"`:(i=c==null?void 0:c.attributes)!=null&&i.class?e=`element with class "${(r=c.attributes)==null?void 0:r.class}"`:"position"in n&&((a=n.position)==null?void 0:a.x)&&((o=n.position)==null?void 0:o.y)&&(e=`position ${Math.round(n.position.x*100)}%, ${Math.round(n.position.y*100)}%`),e?`${n.type} on ${e}`:n.type}case"keypress":return`type "${W(n)}"`;case"typeText":return`type "${n.text}"`}}const nt="1.5.0";class rt extends R{constructor({page:e,testFixture:t}){super(),this.ready=!1,this.page=e,this.testFixture=t}async init(){this.ready=!1,await this.testFixture.step("Connect to Appetize page",async()=>{await this.page.exposeFunction("__appetize_on",e=>{const t=JSON.parse(e,function(r,a){try{if("flag"in a&&a.flag==="TYPED_ARRAY")return global[a.constructor].from(a.data.split(",").map(Number))}catch{}return a}),s=t==="string"?t:t.type,i=t.value;this.emit(s,i),this.emit("*",{type:s,value:i})}),await this.page.evaluate(async([e])=>new Promise((t,s)=>{const i=setTimeout(()=>{clearInterval(r),s(new _("Timed out after 60000ms waiting for connection to Appetize page"))},6e4),r=setInterval(()=>{const a=new MessageChannel;a.port1.onmessage=()=>{clearInterval(r),clearTimeout(i),a.port1.close(),a.port2.close(),t(!1)},window.postMessage({type:"init",appetizeClient:!0,version:e},"*",[a.port2]),window.__appetize_postMessage=async(o,c=!1)=>{const h=new MessageChannel;if(window.postMessage(o,"*",[h.port2]),c)return new Promise((u,p)=>{const y=setTimeout(()=>{p(new _("Timed out after 60000ms while waiting for postMessage response"))},6e4);h.port1.onmessage=g=>{clearTimeout(y),h.port1.close(),h.port2.close(),u(g.data)}});h.port1.close(),h.port2.close()}},100)}),[nt]),await this.page.evaluate(()=>{window.addEventListener("message",e=>{var t;if(e.source===window){switch(typeof e.data=="string"?e.data:(t=e.data)==null?void 0:t.type){case"frameData":case"recordedAction":case"playbackFoundAndSent":case"playbackNotFound":case"debug":case"interceptRequest":case"interceptResponse":case"interceptError":case"uiDump":return}window.__appetize_on(JSON.stringify(e.data,function(i,r){return r instanceof Int8Array||r instanceof Uint8Array||r instanceof Uint8ClampedArray||r instanceof Int16Array||r instanceof Uint16Array||r instanceof Int32Array||r instanceof Uint32Array||r instanceof Float32Array||r instanceof Float64Array?{constructor:r.constructor.name,data:r.join(","),flag:"TYPED_ARRAY"}:r}))}})},[])}),this.ready=!0}async waitUntilReady(){return X(async()=>{if(!this.ready)throw new _("Timed out after 60000ms while waiting for Appetize window to be ready.")},6e4)}async postMessage(e,t=!1){await this.waitUntilReady();try{return await this.testFixture.step("postMessage",async()=>this.page.evaluate(async([s,i])=>window.__appetize_postMessage(s,i),[e,t]))}catch(s){throw m.error("Error sending postMessage: ",e),s}}}class he extends R{constructor({page:e,type:t,window:s}){super(),this.page=e,this.type=t,this.window=s,this.window.on("*",({type:i,value:r})=>{switch(i){case"socketEvent":if(r.socket===this.type){const a=r.type,o=r.value;this.emit(a,o),this.emit("*",{type:a,value:o})}break;case"disconnect":this.emit("disconnect"),this.emit("*",{type:"disconnect"});break;case"sessionInfo":case"chromeDevToolsUrl":case"orientationChanged":case"deviceInfo":this.type==="appetizer"&&(this.emit(i,r),this.emit("*",{type:i,value:r}));break;case"sessionRequested":this.type==="webserver"&&(this.emit(i,r),this.emit("*",{type:i,value:r}));break}})}async send(e,t){return this.window.postMessage({type:"emitSocketEvent",value:{type:e,value:t,socket:this.type}})}async disconnect(){await this.send("disconnect")}waitForEvent(e,t){return O(this,e,t)}}class le extends Ze{constructor({page:e,config:t,window:s,testFixture:i,...r}){const a=new he({page:e,window:s,type:"appetizer"});super({...r,socket:a,config:t,logger:m}),this.actionLogs=[],this.window=s,this.page=e,this.config=t,this.testFixture=i,this.page.on("load",()=>{this.emit("disconnect")}),this.adbShellCommand=this.wrapAsStep(this.adbShellCommand),this.biometry=this.wrapAsStep(this.biometry),this.findElement=this.wrapAsStep(this.findElement,{subStepTitle:o=>JSON.stringify(o)}),this.findElements=this.wrapAsStep(this.findElements,{subStepTitle:o=>JSON.stringify(o)}),this.getUI=this.wrapAsStep(this.getUI),this.keypress=this.wrapAsStep(this.keypress,{subStepTitle:o=>JSON.stringify(o)}),this.launchApp=this.wrapAsStep(this.launchApp,{subStepTitle:o=>JSON.stringify(o)}),this.openUrl=this.wrapAsStep(this.openUrl,{subStepTitle:o=>JSON.stringify(o)}),this.playAction=this.wrapAsStep(this.playAction,{subStepTitle:o=>JSON.stringify(o)}),this.playActions=this.wrapAsStep(this.playActions,{subStepTitle:o=>JSON.stringify(o)}),this.reinstallApp=this.wrapAsStep(this.reinstallApp),this.restartApp=this.wrapAsStep(this.restartApp),this.rotate=this.wrapAsStep(this.rotate,{subStepTitle:o=>JSON.stringify(o)}),this.screenshot=this.wrapAsStep(this.screenshot),this.setLanguage=this.wrapAsStep(this.setLanguage,{subStepTitle:o=>JSON.stringify(o)}),this.setLocation=this.wrapAsStep(this.setLocation,{subStepTitle:o=>JSON.stringify(o)}),this.shake=this.wrapAsStep(this.shake),this.swipe=this.wrapAsStep(this.swipe,{subStepTitle:o=>JSON.stringify(o)}),this.tap=this.wrapAsStep(this.tap,{subStepTitle:o=>JSON.stringify(o)}),this.type=this.wrapAsStep(this.type,{subStepTitle:o=>JSON.stringify(o)}),this.waitForAnimations=this.wrapAsStep(this.waitForAnimations),this.waitForElement=this.wrapAsStep(this.waitForElement,{subStepTitle:o=>JSON.stringify(o)}),this.waitForEvent=this.wrapAsStep(this.waitForEvent,{title:o=>`session.waitForEvent - ${JSON.stringify(o)}`}),this.waitForTimeout=this.wrapAsStep(this.waitForTimeout,{title:o=>`session.waitForTimeout - ${JSON.stringify(o)}`})}async addActionLog(e){if(e.error){const t=await this.getUI().catch(this.logger.warn);t&&(e.ui=t)}this.actionLogs.push(e)}async rotate(e){try{const[t]=await Promise.all([O(this.window,"orientationChanged"),await this.window.postMessage(e==="left"?"rotateLeft":"rotateRight")]);return this.window.page.waitForTimeout(1e3),t}catch(t){throw w(t,this.rotate),t}}async record(){try{if(!this.config.record)throw new x("Recording is not enabled, please enable it by setting `record: true` in session config");if(!this.testFixture)throw new x("session.record() requires using `session` from the test() arguments");return new st({session:this,testInfo:this.testFixture.info()}).record()}catch(e){throw w(e,this.record),e}}async waitForEvent(e,t){try{return await O(this,e,t)}catch(s){throw w(s,this.waitForEvent),s}}async waitForTimeout(e){try{return await B(e)}catch(t){throw w(t,this.waitForTimeout),t}}async waitForElement(e,t){try{const s=await this.findElements(e,t);if(s.length){if((t==null?void 0:t.matches)&&s.length!==t.matches)throw new Error(`Expected ${t.matches} elements, found ${s.length}`);return s}else throw new Error(`Element not found:
${JSON.stringify(e)}`)}catch(s){throw w(s,this.waitForElement),s}}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}async getVideoFrames(){return console.warn("getVideoFrames() is deprecated. Use session.on('video') event instead"),[]}async getAudioFrames(){return console.warn("getAudioFrames() is deprecated. Use session.on('audio') event instead"),[]}wrapAsStep(e,t={}){return(...s)=>{var a;let i=`session.${e.name}`;t!=null&&t.title&&(i=t.title(...s));const r=(a=t==null?void 0:t.subStepTitle)==null?void 0:a.call(t,...s);return r?this.testFixture.step(i,()=>this.testFixture.step(r,()=>e.apply(this,s)),{box:!0}):this.testFixture.step(i,()=>e.apply(this,s),{box:!0})}}}const ue=new WeakMap;class pe extends We{constructor({page:e,testFixture:t}){var a;const s=(a=ue.get(e))!=null?a:new rt({page:e,testFixture:t});ue.set(e,s);const i=new he({type:"webserver",page:e,window:s});super({socket:i,window:s,logger:m,autoInit:!1}),this.window=s,this.page=e,this.testFixture=t;let r=!1;this.on("queue",o=>{r||(r=!0,o.type==="concurrent"?this.logger.log(`Entered ${o.name}. Please wait until a slot becomes available.`):this.logger.log("All devices are currently in use. Please wait until requested device becomes available.")),o.position>0&&(o.type==="concurrent"?this.logger.log(`Position in ${o.name}: ${o.position}`):this.logger.log(`Position in queue: ${o.position}`))}),this.on("session",()=>{r&&(r=!1)})}async init(){return this.testFixture.step("Initialize client",async()=>{await this.window.init(),await super.init()})}validateConfig(e){var s;return{codec:((s=this.page.context().browser())==null?void 0:s.browserType().name())==="chromium"?"jpeg":"h264",...e}}createSession(e,t){return this.session=new le({config:e,page:this.page,window:this.window,path:t.path,token:t.token,device:this.device,app:this.app,testFixture:this.testFixture}),this.session}}class ot{constructor(e){var t;this.queueStart=null,this.queueEnd=null,this.baseURL="https://appetize.io",this.sessionDebugInfo={playedActions:[],videoFrames:[],audioFrames:[],debugLogs:[]},this.page=e.page,this.testFixture=e.testFixture,this.config={...e.config,buildId:(t=e.config.buildId)!=null?t:e.config.publicKey,...e.config.publicKey?{publicKey:e.config.publicKey}:{}},e.baseURL&&(this.baseURL=e.baseURL)}get queueTime(){var e;return this.queueStart?((e=this.queueEnd)!=null?e:Date.now())-this.queueStart:null}async init(){var s;const e={};for(const i in this.config)switch(i){case"device":case"osVersion":case"scale":case"orientation":e[i]=this.config[i];break}const t=await this.page.goto(`${this.baseURL}/embed/${this.config.buildId}?${_e(e)}`);if((t==null?void 0:t.status())===404){const i=this.config.publicKey?"publicKey":"buildId";throw new Error(`App not found for ${i} "${(s=this.config.publicKey)!=null?s:this.config.buildId}"`)}this.client=new pe({page:this.page,testFixture:this.testFixture}),await this.client.init()}async start(e){this.queueStart=null,this.queueEnd=null,this.client.on("queue",()=>{this.queueStart||(this.queueStart=Date.now())}),this.client.on("queueEnd",()=>{this.queueStart&&(this.queueEnd=Date.now())});const t=async i=>{i!=null&&i.embed&&await this.page.setViewportSize({width:i.embed.width+8,height:i.embed.height+8})};this.client.on("deviceInfo",t),await this.client.waitUntilReady(),this.client.device&&t(this.client.device);const s=await Me(()=>this.client.startSession(e.config),{retries:5,timeout:3e4,predicate:(i,r)=>i instanceof Error&&i.message.match(/too many requests/)?(console.warn(`Too many session requests. Retrying in 30 seconds... (attempt #${r})`),!0):!1});return this.config=s.config,this.requestKeyFrame(),s.config.debug===!0&&s.on("log",i=>{this.sessionDebugInfo.debugLogs.push(i.message)}),s.on("playbackFoundAndSent",i=>{this.sessionDebugInfo.playedActions.push(i)}),s.on("playbackError",i=>{this.sessionDebugInfo.playedActions.push(i)}),s.on("video",i=>{this.sessionDebugInfo.videoFrames.push(i)}),s.on("audio",i=>{this.sessionDebugInfo.audioFrames.push(i)}),s.on("end",()=>{this.session=void 0}),this.session=s,s}onTestStart(){this.clearSessionDebugInfo(),this.requestKeyFrame()}clearSessionDebugInfo(){this.sessionDebugInfo.playedActions=[],this.sessionDebugInfo.videoFrames=[],this.sessionDebugInfo.audioFrames=[],this.sessionDebugInfo.debugLogs=[]}requestKeyFrame(){this.session&&this.testFixture.step("",async()=>{var e;return(e=this.session)==null?void 0:e.socket.send("requestKeyFrame").catch(()=>{})})}}const F=Y.promisify(Ie.exec),at=Y.promisify(A.default.readFile),ct=Y.promisify(A.default.writeFile);async function ht(n,e){const t=n.adbConnection,s="localhost",i=6e3;if(!t)throw new Error("ADB connection info not found. Session must be configured with `enableAdb: true`");await dt();try{await F(`adb disconnect ${s}:${i}`)}catch{}const r=`ssh -fN -o StrictHostKeyChecking=no -oHostKeyAlgorithms=+ssh-rsa -p ${t.port} ${t.user}@${t.hostname} -L${i}:${t.forwards[0].destination}:${t.forwards[0].port}`,a=await F(r);a.stdout&&m.error(a.stdout),a.stderr&&m.error(a.stderr);const o=`adb connect ${s}:${i}`,c=await F(o);c.stdout&&m.error(c.stdout),c.stderr&&m.error(c.stderr);const h=await $e._android.devices().then(l=>l.find(f=>f.serial()===`${s}:${i}`));if(!h)throw new Error(`Device ${s}:${i} not found`);m.debug(`Connected to device ${h.model()} with serial ${h.serial()}`);const u=await ut(e),p=await h.launchBrowser({args:u});await pt(e,`chrome ${u.join(" ")}`);const y=p.pages();return y[0]?{page:y[0],browserContext:p,device:h}:{page:await p.newPage(),browserContext:p,device:h}}async function lt(n){await n.close(),await F(`adb disconnect ${n.serial()}`)}async function ut(n){const e=n.outputPath(),t=n.outputPath("chrome-command-line"),s="/data/local/tmp/chrome-command-line";let i=[];try{await F(`adb pull ${s} ${e}`);const r=await at(t,"utf-8");if(r){const a=r.split("chrome ").at(1);a&&(i=a.split(" ")||[])}await F(`adb push ${t} ${s}`)}catch{}return i}async function pt(n,e){const t=n.outputPath("chrome-command-line"),s="/data/local/tmp/chrome-command-line";try{await ct(t,e),await F(`adb push ${t} ${s}`)}catch(i){m.error("Error pushing chrome-command-line file",i)}}async function dt(){try{await F("adb version")}catch{throw new Error("ADB is not installed or not found in PATH. Please install ADB and ensure it is accessible.")}}let P=null,Q=null;const q=S.test.extend({config:[async({_useConfig:n},e,t)=>{const s={...t.project.use.config,...n,autoplay:!1};"publicKey"in s&&!!s.publicKey&&("buildId"in s&&!!s.buildId?(m.warn(`Both "buildId" ("${s.buildId}") and "publicKey" ("${s.publicKey}") were defined in the test config. Using buildId.`),s.publicKey=s.buildId):s.buildId=s.publicKey),await e(s)},{auto:!0}],async page({context:n,config:e,baseURL:t},s,i){if(be(i)){P!=null||(P=await Se(n,e,t));const a=await xe(P,e);if(a.config.platform!=="android")throw new Error("Appetize browser tests are currently only supported on Android devices.");const{page:o,browserContext:c,device:h}=await ht(a,i);try{await s(o),await c.close()}finally{await lt(h)}return}const r=await n.newPage();await s(r)},async appetizePage({context:n,config:e,baseURL:t},s,i){if(!be(i))throw new Error("Appetize config not found in test. Either define it in the Playwright project or with test.use({ config: { ... } })");if(P){const{session:r,page:a}=P;if(r){let o=!1;if(Q){for(const c in e)if(JSON.stringify(Q[c])!==JSON.stringify(e[c])){o=!0;break}}else o=!0;o&&(r&&await r.end().catch(()=>{}),await a.close(),P=null)}}P||(P=await Se(n,e,t)),Q=e,await s(P)},async session({appetizePage:n,config:e,_doSetupAndTeardown:t},s){const i=await xe(n,e);await s(i)},async client({appetizePage:n},e){await e(n.client)},_useConfig:[{},{option:!0}],_autoSnapshotSuffix:[async({},n,e)=>{e.snapshotSuffix="",await n()},{auto:!0}],_doSetupAndTeardown:[async({appetizePage:n},e,t)=>{m.clearLogHistory(),n&&n.onTestStart(),await e();try{await me({appetizePage:n,testInfo:t})}catch(s){m.error("Failed to save attachments",s)}t.status==="timedOut"&&n.queueTime&&m.error("Test timed out while in queue for a device. You may increase your test timeout to account for higher queue times.");try{ge(t)}catch{}},{auto:!1}],context:[async({_browserContext:n,video:e,contextOptions:t},s)=>{e&&e!=="off"&&m.warn.once("Video recording is not yet supported with @appetize/playwright. Use tracing instead to view recordings of your tests https://docs.appetize.io/javascript-sdk/playwright/trace-viewer"),Object.keys(t).length&&m.warn.once("contextOptions are not supported with @appetize/playwright"),await s(n)},{scope:"test"}],_browserContext:[async({browser:n},e)=>{const t=await n.newContext();await e(t),await t.close()},{scope:"worker"}]}),de=n=>{const e=n.use;return t=>{const{config:s,...i}=t;return e({...i,_useConfig:s})}},fe=n=>{const e=n.afterEach;return t=>(e(async({appetizePage:s},i)=>{if(s)try{await me({appetizePage:s,testInfo:i})}catch(r){m.error("Failed to save attachments",r)}}),e(t))},we=n=>{const e=n.extend;return t=>{const s=e(t);return s.afterEach=fe(s).bind(s),s.use=de(s).bind(s),s.extend=we(s).bind(s),s}};Object.assign(q,{use:de(q),afterEach:fe(q),extend:we(q),setup(n){return{}.__APPETIZE__SETUP_WARNED||m.warn("test.setup() is deprecated and will be removed in a future release. Use test.use({ config: {...} }) instead"),D.use({config:n})}});const D=q,ye=new WeakMap;async function me(n){const{appetizePage:e,testInfo:t}=n,s=e.session;if(!(t.status==="failed"||t.status==="timedOut"||t.status==="interrupted")||ye.get(t.fn))return;ye.set(t.fn,!0);const r=C.default.join(De.default.tmpdir(),`appetize-playwright-${t.testId}-${t.workerIndex}`),a=async()=>{A.default.existsSync(r)&&await A.default.promises.rm(r,{recursive:!0,force:!0}).catch(()=>{})};try{await a(),await A.default.promises.mkdir(r);const o=e.sessionDebugInfo.playedActions,c=async()=>{try{if(s){const l=await s.screenshot("buffer"),f=C.default.join(r,"screenshot.png");await A.default.promises.writeFile(f,Buffer.from(l.data)),await t.attach("screenshot",{path:f,contentType:"image/png"})}}catch(l){m.error("Failed to attach screenshot.png",l instanceof Error?l.message:void 0)}},h=async()=>{try{const l=o.map(L=>{if("screenshot"in L){const{screenshot:G,...U}=L;return U}return L});if(!l.length)return;const f=JSON.stringify(l,null,2),b=C.default.join(r,"actions.json");await A.default.promises.writeFile(b,f),await t.attach("actions",{path:b,contentType:"application/json"})}catch(l){m.error("Failed to attach actions.json",l instanceof Error?l.message:void 0)}},u=async()=>{try{const{videoFrames:l}=e.sessionDebugInfo;if(l.length===0||l.some(U=>U.codec!=="h264"))return;const f="video",b=new Ce.default({mode:f,fps:15}),L=await new Promise((U,Ee)=>{const Ae=setTimeout(()=>{Ee(new Error("Timed out muxing session video"))},3e4),Z=new Pe.Readable({objectMode:!0,read(){}}),wt=Buffer.concat(l.map(K=>Buffer.from(K.buffer)));Z.push({video:wt}),Z.push(null);let ee=Buffer.from([]);Z.pipe(b.createStream()).on("data",K=>{ee=Buffer.concat([ee,K])}).on("error",K=>{clearTimeout(Ae),Ee(K)}).on("end",()=>{clearTimeout(Ae),U(ee)})}),G=C.default.join(r,"video.mp4");await A.default.promises.writeFile(G,L),await t.attach("video.mp4",{path:G,contentType:"video/mp4"})}catch(l){m.error("Failed to attach video.mp4",l instanceof Error?l.message:void 0)}},p=async()=>{if(!!m.logHistory.length)try{const l=`${m.logHistory.map(b=>`[${b.method}] ${JSON.stringify(b.data).slice(2,-2)}`).join(`
`)}`,f=C.default.join(r,"sdk-logs.txt");await A.default.promises.writeFile(f,l),await t.attach("sdk-logs",{path:f,contentType:"application/text"})}catch(l){m.error("Failed to attach sdk-logs.txt",l)}},y=async()=>{const{debugLogs:l}=e.sessionDebugInfo;if(l.length>0)try{const f=l.join(""),b=C.default.join(r,"debug-logs.txt");await A.default.promises.writeFile(b,f),await t.attach("debug-logs",{path:b,contentType:"application/text"})}catch(f){m.error("Failed to attach debug-logs.txt",f)}},g=async()=>{try{if(e.session){const l=C.default.join(r,"session.json"),f=JSON.stringify({path:e.session.path,token:e.session.token,config:e.session.config},null,2);await A.default.promises.writeFile(l,f),await t.attach("session",{path:l,contentType:"application/json"})}}catch(l){m.error("Failed to attach session.json",l)}};await Promise.all([c(),h(),u(),y(),g()]),await p()}finally{await a()}}function ge(n){const e=n.steps||n._steps;!e||e.forEach((t,s)=>{t.title===""&&e.splice(s,1),ge(t)})}function be(n){return!!n.project.use.config}async function Se(n,e,t){if(!e.buildId)throw new Error('Appetize buildId not set. Make sure you have set it with `test.use({ config: { buildId: "..." } })` or in your Playwright config file.');const s=new ot({page:await n.newPage(),testFixture:D,config:e,baseURL:t});return await s.init(),s}async function xe(n,e){let t=n.session;return t||(t=await D.step("Start Appetize session",async()=>{if(await n.start({config:e}),n.queueTime&&D.info().annotations.push({type:"queueTime",description:`${n.queueTime}ms`}),!n.session)throw new Error("Appetize session failed to start");return n.session},{box:!0}),D.info().annotations.push({type:"Appetize Documentation",description:"https://docs.appetize.io/testing"})),t.testFixture=D,t}var ft=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));Object.defineProperty(d,"expect",{enumerable:!0,get:function(){return S.expect}}),d.InternalRecorderAPI=ft,d.PlaywrightClient=pe,d.PlaywrightSession=le,d.test=D,Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=index.umd.js.map
